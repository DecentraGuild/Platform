import{I as N}from"./Cov751Ou.js";import{e as E,r,J as C,z as P,K as F,L as J,i as B,w as f,k as t,o,b as _,a as n,c as l,d as c,F as T,t as m,l as V,g as S,N as z,M as R,_ as U}from"./Cuem3LDA.js";import{B as j}from"./Bl7VwagC.js";import{C as Y}from"./DzKUzsOz.js";import{P as H}from"./3RHYZAmY.js";import{C as K}from"./CSnhJXAl.js";import{u as q}from"./CJvSuGTU.js";import"./DG6ESaol.js";import"./C-xuITp_.js";const G={key:0,class:"discord-page__loading"},Q={key:1,class:"discord-page__hint"},X={key:2,class:"discord-page__hint"},Z={class:"discord-page__section"},ee={class:"discord-page__id"},te={class:"discord-page__section"},se={class:"discord-page__heading"},oe={key:0,class:"discord-page__wallets"},ae={class:"discord-page__address"},ne={key:0,class:"discord-page__badge"},le={key:1,class:"discord-page__hint-small"},ie={key:2,class:"discord-page__error"},re=E({__name:"discord",setup(de){const w=q(),i=r(null),k=r(!0),v=r(!1),g=r(!1),u=r(!1),d=r(null),h=r(null),p=r(C());function M(s){return!s||s.length<12?s:`${s.slice(0,6)}...${s.slice(-4)}`}async function y(){k.value=!0;try{const s=await fetch(`${w.value}/api/v1/discord/me`,{credentials:"include"});if(s.status===401){v.value=!1,i.value=null;return}v.value=!0;const e=await s.json();i.value=e}catch{i.value=null}finally{k.value=!1}}async function W(s){const e=w.value.replace(/\/$/,""),a=await fetch(`${e}/api/v1/auth/nonce`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({wallet:s}),credentials:"include"});if(!a.ok){const b=await a.json().catch(()=>({}));throw new Error(b.error??"Failed to get nonce")}const{nonce:D}=await a.json(),{signature:x,message:A}=await R(D),L=await fetch(`${e}/api/v1/discord/link-additional-wallet`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({wallet:s,message:A,signature:x}),credentials:"include"});if(!L.ok){const b=await L.json().catch(()=>({}));throw new Error(b.error??"Link failed")}}async function I(s){d.value=null,u.value=!0;try{if(await z(s),p.value=C(),!p.value.account){d.value="Wallet not connected";return}await W(p.value.account),g.value=!1,await y()}catch(e){d.value=e instanceof Error?e.message:"Something went wrong"}finally{u.value=!1}}async function O(s){h.value=s;try{(await fetch(`${w.value}/api/v1/discord/verify/revoke`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({wallet:s}),credentials:"include"})).ok&&await y()}finally{h.value=null}}let $=null;return P(()=>{$=F(()=>{p.value=C()}),y()}),J(()=>{$?.()}),(s,e)=>(o(),B(t(H),{title:"Discord"},{default:f(()=>[_(t(Y),{class:"discord-page__card"},{default:f(()=>[e[9]||(e[9]=n("p",{class:"discord-page__intro"}," Your Discord link and linked wallets are shared across all communities. Role eligibility is based on the combined holdings of all linked wallets. ",-1)),t(k)?(o(),l("p",G,[_(t(N),{icon:"mdi:loading",class:"discord-page__spinner"}),e[2]||(e[2]=c(" Loadingâ€¦ ",-1))])):t(v)?t(i)?.discord_user_id?(o(),l(T,{key:3},[n("div",Z,[e[5]||(e[5]=n("h3",{class:"discord-page__heading"},"Linked to Discord",-1)),n("p",ee,[e[4]||(e[4]=c("Account ID: ",-1)),n("code",null,m(t(i).discord_user_id),1)])]),n("div",te,[n("h3",se,"Linked wallets ("+m(t(i).linked_wallets?.length??0)+")",1),e[8]||(e[8]=n("p",{class:"discord-page__hint-small"},"Holdings from these wallets are combined for role rules.",-1)),t(i).linked_wallets?.length?(o(),l("ul",oe,[(o(!0),l(T,null,V(t(i).linked_wallets,a=>(o(),l("li",{key:a,class:"discord-page__wallet-row"},[n("code",ae,m(M(a)),1),a===t(i).session_wallet?(o(),l("span",ne,"Current")):S("",!0),_(t(j),{variant:"ghost",size:"small",disabled:t(h)===a,onClick:D=>O(a)},{default:f(()=>[...e[6]||(e[6]=[c(" Unlink ",-1)])]),_:1},8,["disabled","onClick"])]))),128))])):(o(),l("p",le,"No wallets linked.")),_(t(j),{variant:"secondary",size:"small",disabled:t(u),class:"discord-page__add",onClick:e[0]||(e[0]=a=>g.value=!0)},{default:f(()=>[t(u)?(o(),B(t(N),{key:0,icon:"mdi:loading",class:"discord-page__spinner"})):S("",!0),e[7]||(e[7]=c(" Link another wallet ",-1))]),_:1},8,["disabled"]),t(d)?(o(),l("p",ie,m(t(d)),1)):S("",!0)]),_(t(K),{open:t(g),title:"Link another wallet",description:"Connect a wallet to add it to your Discord account. Its holdings will be combined with your other linked wallets for roles.",connectors:t(p).connectors,loading:t(u),error:t(d),onClose:e[1]||(e[1]=a=>{g.value=!1,d.value=null}),onSelect:I},null,8,["open","connectors","loading","error"])],64)):(o(),l("p",X,[...e[3]||(e[3]=[c(" You have not linked a wallet to Discord yet. Use ",-1),n("strong",null,"/verify",-1),c(" in your community's Discord server to get a link, then complete the flow to link this (or another) wallet. ",-1)])])):(o(),l("p",Q,"Sign in with your wallet to see your linked Discord and wallets."))]),_:1})]),_:1}))}}),ve=U(re,[["__scopeId","data-v-130b9cf8"]]);export{ve as default};
