import{_ as j}from"./T1n2mv5F.js";import{e as P,o as r,c as f,a as k,l as o,F as R,b as h,w as I,d as q,j as b,k as Z,t as O,g as ee,i as m,a8 as z,_ as K,f as F,h as T,B as te,V as ae,C as ne,m as V,a9 as se,a4 as oe,a5 as M,a6 as x}from"./DhkfeLsH.js";import{b as ce,s as re}from"./DAaVrNXw.js";import{I as le}from"./AfR23o-p.js";import{u as ie,T as U,S as A,a as ue}from"./GhnkrbTW.js";import{B as W}from"./DZ77Mkvz.js";import{t as me,s as Q}from"./DnknCDuH.js";import{a as de,u as pe}from"./py99y60w.js";import{u as ve}from"./Bg9r2jCQ.js";import{u as we}from"./DN_3Odmu.js";const fe={class:"manage-escrow-card"},ke={class:"manage-escrow-card__body"},_e={class:"manage-escrow-card__summary"},ye={key:1,class:"manage-escrow-card__loading"},ge={class:"manage-escrow-card__actions"},be=P({__name:"ManageEscrowCard",props:{escrow:{},escrowLink:{},showQuickCancel:{type:Boolean},cancelling:{type:Boolean}},emits:["cancel"],setup(l){const g=z(l,"escrow"),{data:w}=ie(g),c=m(()=>w.value);return(i,s)=>{const y=j;return r(),f("div",fe,[k("div",ke,[k("div",_e,[o(c)?(r(),f(R,{key:0},[h(o(U),{amount:o(c).depositAmount,decimals:o(c).depositDecimals,symbol:o(c).depositSymbol,name:o(c).depositName,mint:l.escrow.account.depositToken.toBase58(),"show-mint-short":!0},null,8,["amount","decimals","symbol","name","mint"]),s[1]||(s[1]=k("span",{class:"manage-escrow-card__at"},"at",-1)),h(o(U),{amount:l.escrow.account.price??0,decimals:0,symbol:o(c).priceSymbol,name:o(c).requestName,mint:l.escrow.account.requestToken.toBase58(),"show-mint-short":!0},null,8,["amount","symbol","name","mint"]),s[2]||(s[2]=k("span",{class:"manage-escrow-card__per"},"per unit",-1))],64)):(r(),f("span",ye,"Loading..."))]),k("div",ge,[h(y,{to:l.escrowLink,class:"manage-escrow-card__link"},{default:I(()=>[h(o(W),{variant:"ghost"},{default:I(()=>[...s[3]||(s[3]=[q("Details",-1)])]),_:1})]),_:1},8,["to"]),l.showQuickCancel?(r(),b(o(W),{key:0,variant:"ghost",disabled:l.cancelling,onClick:s[0]||(s[0]=Z(C=>i.$emit("cancel"),["stop"]))},{default:I(()=>[q(O(l.cancelling?"Cancelling...":"Cancel"),1)]),_:1},8,["disabled"])):ee("",!0)])])])}}}),he=K(be,[["__scopeId","data-v-4aa0bab3"]]);function Te(l,B){const{fetchMetadata:g}=de(),w=T(null),c=T(!0),i=T(null),s=m(()=>w.value?.decimals??null),y=m(()=>w.value?.symbol??null),C=m(()=>w.value?.name??null),$=m(()=>me(l.value,6,4)),N=m(()=>(s.value,0)),S=m(()=>{const d=N.value;return Number.isFinite(d)?Number.isInteger(d)?String(d):d.toFixed(6).replace(/\.?0+$/,""):"0"}),L=m(()=>({formattedAmount:S.value,decimals:s.value,symbol:y.value??null,name:C.value??null,mintShort:$.value,loading:c.value,error:i.value}));async function _(){const d=l.value;if(!d){c.value=!1;return}c.value=!0,i.value=null;try{const p=await g(d);w.value=p?{name:p.name,symbol:p.symbol,decimals:p.decimals}:null}catch(p){i.value=p instanceof Error?p.message:"Failed to load metadata"}finally{c.value=!1}}return F(l,_,{immediate:!0}),{data:L,load:_}}const Be={class:"mint-label"},Ce=P({__name:"MintLabel",props:{mint:{}},setup(l){const B=l,g=z(B,"mint"),{data:w}=Te(g),c=m(()=>{const i=w.value,s=Q(i?.name??null),y=Q(i?.symbol??null);return s||y||(i?.mintShort??B.mint.slice(0,8)+"...")});return(i,s)=>(r(),f("span",Be,O(c.value),1))}}),$e=K(Ce,[["__scopeId","data-v-eb0b8ce9"]]),Me={class:"market-open-trades"},Ae={key:2},Le={class:"market-open-trades__toolbar"},xe={key:3,class:"market-open-trades__list"},Ie={class:"market-open-trades__group-heading"},Ne={class:"market-open-trades__group-items"},Se=P({__name:"MarketOpenTradesView",props:{tabActive:{type:Boolean,default:!1}},emits:["open-create-trade"],setup(l,{emit:B}){const g=l,w=B;function c(n){return N(n,{tab:"open-trades"})}const i=te(),s=ae(),{rpcUrl:y}=pe(),C=we(),$=ve(),{escrowLink:N}=ue(m(()=>i.slug)),S=m(()=>s.connectorState.value?.connected??!1),L=m(()=>s.connectorState.value?.account??null),_=T([]),d=T(!0),p=T(null),D=T(null),G=m(()=>{const n=_.value;if(!n.length)return[];const e=new Map;for(const a of n){const t=a.account.depositToken.toBase58(),v=e.get(t)??[];v.push(a),e.set(t,v)}for(const a of e.values())a.sort((t,v)=>(t.account.price??0)-(v.account.price??0));const u=[...e.entries()].map(([a,t])=>({depositMint:a,escrows:t,minPrice:Math.min(...t.map(v=>v.account.price??0))}));return u.sort((a,t)=>a.minPrice-t.minPrice),u.map(({depositMint:a,escrows:t})=>({depositMint:a,escrows:t}))});function H(n){const e=n.account;return{publicKey:new M(n.publicKey),account:{maker:new M(e.maker),depositToken:new M(e.depositToken),requestToken:new M(e.requestToken),tokensDepositInit:new x(e.tokensDepositInit),tokensDepositRemaining:new x(e.tokensDepositRemaining),price:e.price,decimals:e.decimals,slippage:e.slippage,seed:new x(e.seed),authBump:0,vaultBump:0,escrowBump:0,expireTimestamp:new x(e.expireTimestamp),recipient:new M(e.recipient),onlyRecipient:e.onlyRecipient,onlyWhitelist:e.onlyWhitelist,allowPartialFill:e.allowPartialFill,whitelist:new M(e.whitelist)}}}async function E(){const n=L.value,e=i.slug;if(!$.value||!e||!n){d.value=!1;return}d.value=!0,p.value=null;try{const u=`${$.value}/api/v1/tenant/${encodeURIComponent(e)}/marketplace/escrows?maker=${encodeURIComponent(n)}`,a=await fetch(u);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.json(),v=Array.isArray(t.escrows)?t.escrows:[];_.value=v.map(H)}catch(u){p.value=u instanceof Error?u.message:"Failed to load escrows",_.value=[]}finally{d.value=!1}}F(()=>[L.value,i.slug,$.value],()=>{E()},{immediate:!1}),F(()=>g.tabActive,n=>{n&&E()}),ne(()=>{E()});async function X(n){const e=se();if(!e||!n)return;const u=n.publicKey.toBase58();D.value=u;const a=`cancel-${u}-${Date.now()}`;C.add(a,{status:"pending",message:"Cancelling escrow..."});try{const t=new oe(y.value),v=await ce({maker:n.account.maker,depositTokenMint:n.account.depositToken,requestTokenMint:n.account.requestToken,seed:n.account.seed,connection:t,wallet:e}),Y=await re(t,v,e,n.account.maker);C.update(a,{status:"success",message:"Escrow cancelled",signature:Y}),_.value=_.value.filter(J=>J.publicKey.toBase58()!==u)}catch(t){C.update(a,{status:"error",message:t instanceof Error?t.message:"Cancel failed"})}finally{D.value=null}}return(n,e)=>{const u=j;return r(),f("div",Me,[o($)?S.value?(r(),f("div",Ae,[k("div",Le,[k("button",{type:"button",class:"market-open-trades__create-btn",onClick:e[0]||(e[0]=a=>w("open-create-trade"))},[h(o(le),{icon:"mdi:plus",class:"market-open-trades__create-btn-icon"}),e[1]||(e[1]=k("span",null,"New trade",-1))])]),d.value?(r(),b(o(A),{key:0,variant:"loading",message:"Loading your escrows..."})):p.value?(r(),b(o(A),{key:1,variant:"error",message:p.value},null,8,["message"])):_.value.length?(r(),f("div",xe,[(r(!0),f(R,null,V(G.value,a=>(r(),f("section",{key:a.depositMint,class:"market-open-trades__group"},[k("h3",Ie,[h($e,{mint:a.depositMint},null,8,["mint"])]),k("div",Ne,[(r(!0),f(R,null,V(a.escrows,t=>(r(),b(u,{key:t.publicKey.toBase58(),to:c(t.publicKey.toBase58()),class:"market-open-trades__row-link"},{default:I(()=>[h(he,{escrow:t,"escrow-link":c(t.publicKey.toBase58()),"show-quick-cancel":!0,cancelling:D.value===t.publicKey.toBase58(),onCancel:v=>X(t)},null,8,["escrow","escrow-link","cancelling","onCancel"])]),_:2},1032,["to"]))),128))])]))),128))])):(r(),b(o(A),{key:2,variant:"empty",message:"You have no open escrows in this dGuild."}))])):(r(),b(o(A),{key:1,variant:"info",message:"Connect your wallet to manage your escrows."})):(r(),b(o(A),{key:0,variant:"error",message:"API is not configured. Set NUXT_PUBLIC_API_URL."}))])}}}),Qe=K(Se,[["__scopeId","data-v-17c3f922"]]);export{Qe as default};
