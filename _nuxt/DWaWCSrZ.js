import{a4 as Re,h as I,i as u,a5 as P,a6 as K,e as j,o as l,j as R,a7 as De,w as fe,a as s,c as i,b as q,l as m,t as y,g as $,_ as Y,F as B,d as ve,a8 as Ee,x as de,m as L,B as Ie,K as xe,V as Pe,C as Ue,f as Oe,s as Ve,v as Ke,M as me}from"./DhkfeLsH.js";import{I as A}from"./AfR23o-p.js";import{e as ze,t as se,s as te}from"./DnknCDuH.js";import{u as He,T as We,S as W,a as je}from"./GhnkrbTW.js";import{f as Ye}from"./DAaVrNXw.js";import{u as Ge}from"./py99y60w.js";import{u as Je}from"./Cd251aCs.js";import{u as Qe}from"./Dr-6QOM-.js";import{_ as Xe}from"./T1n2mv5F.js";import{u as Ze}from"./Bg9r2jCQ.js";import{g as et,n as tt,f as st,a as at}from"./Bbny_65O.js";import"./yq63690G.js";const nt=1e-7;function lt(a,n){const _=Math.max(1,Math.round(nt*10**n));return a.lt(new K(_))}function ot(a){const n=a.account;return{publicKey:new P(a.publicKey),account:{maker:new P(n.maker),depositToken:new P(n.depositToken),requestToken:new P(n.requestToken),tokensDepositInit:new K(n.tokensDepositInit),tokensDepositRemaining:new K(n.tokensDepositRemaining),price:ze(n.price),decimals:n.decimals,slippage:n.slippage,seed:new K(n.seed),authBump:0,vaultBump:0,escrowBump:0,expireTimestamp:new K(n.expireTimestamp),recipient:new P(n.recipient),onlyRecipient:n.onlyRecipient,onlyWhitelist:n.onlyWhitelist,allowPartialFill:n.allowPartialFill,whitelist:new P(n.whitelist)}}}function it(a,n,_){const d=I([]),h=u(()=>{const g=new Map,S=d.value,b=a.value;for(const c of S){const w=c.account.depositToken.toBase58(),T=c.account.requestToken.toBase58();if(b.has(w)){let k=g.get(w);k||(k={offerTrades:[],requestTrades:[]},g.set(w,k)),k.offerTrades.push(c)}if(b.has(T)){let k=g.get(T);k||(k={offerTrades:[],requestTrades:[]},g.set(T,k)),k.requestTrades.push(c)}}return g}),p=I(!1),M=I(null);async function N(){const g=_?.apiUrl?.value??"",S=_?.slug?.value;if(g&&S&&g.length>0){p.value=!0,M.value=null;try{const c=await fetch(`${g}/api/v1/tenant/${encodeURIComponent(S)}/marketplace/escrows`);if(!c.ok)throw new Error(`HTTP ${c.status}`);const w=await c.json(),T=Array.isArray(w.escrows)?w.escrows:[];d.value=T.map(ot)}catch(c){M.value=c instanceof Error?c.message:"Failed to load escrows",d.value=[]}finally{p.value=!1}return}if(!n.value){M.value="RPC URL not configured";return}p.value=!0,M.value=null;try{const c=new Re(n.value),w=await Ye(c),T=a.value;d.value=w.filter(k=>{const U=k.account.depositToken.toBase58(),z=k.account.requestToken.toBase58(),G=T.has(U)&&T.has(z),J=!lt(k.account.tokensDepositRemaining,k.account.decimals);return G&&J})}catch(c){M.value=c instanceof Error?c.message:"Failed to load escrows",d.value=[]}finally{p.value=!1}}return{escrows:d,byMint:h,loading:p,error:M,retry:N}}const rt={class:"asset-card__media"},ct=["src","alt"],ut={key:1,class:"asset-card__placeholder"},dt={class:"asset-card__body"},mt={class:"asset-card__name"},_t={class:"asset-card__symbol"},ft={class:"asset-card__mint"},vt={class:"asset-card__open-trades"},pt={key:0,class:"asset-card__count asset-card__count--offer"},bt={key:1,class:"asset-card__count asset-card__count--request"},kt={key:2,class:"asset-card__count asset-card__count--muted"},yt=j({__name:"AssetCard",props:{mint:{},assetType:{},name:{},symbol:{},image:{},offerCount:{},requestCount:{},linkTo:{},collectionMint:{}},emits:["select"],setup(a){return(n,_)=>(l(),R(De(a.linkTo?n.NuxtLink:"button"),{to:a.linkTo,type:"button",class:"asset-card",onClick:_[0]||(_[0]=d=>!a.linkTo&&n.$emit("select",{mint:a.mint,assetType:a.assetType,collectionMint:a.collectionMint??void 0}))},{default:fe(()=>[s("div",rt,[a.image?(l(),i("img",{key:0,src:a.image,alt:a.name,class:"asset-card__img",loading:"lazy"},null,8,ct)):(l(),i("div",ut,[q(m(A),{icon:"mdi:image-off",class:"asset-card__placeholder-icon"})]))]),s("div",dt,[s("span",mt,y(a.name||m(se)(a.mint)),1),s("span",_t,y(a.symbol??"—"),1),s("span",ft,y(m(se)(a.mint)),1)]),s("div",vt,[(a.offerCount??0)>0?(l(),i("span",pt,y(a.offerCount)+" offered",1)):$("",!0),(a.requestCount??0)>0?(l(),i("span",bt,y(a.requestCount)+" requested",1)):$("",!0),(a.offerCount??0)===0&&(a.requestCount??0)===0?(l(),i("span",kt,"No trades")):$("",!0)])]),_:1},8,["to"]))}}),wt=Y(yt,[["__scopeId","data-v-313c3255"]]),ht={class:"trade-list-item"},gt={class:"trade-list-item__cell trade-list-item__cell--deposit"},Tt={class:"trade-list-item__cell trade-list-item__cell--requested"},Ct={class:"trade-list-item__requested"},Mt={class:"trade-list-item__requested-label"},$t={class:"trade-list-item__cell trade-list-item__cell--unit"},Nt={class:"trade-list-item__unit-price"},qt={class:"trade-list-item__cell trade-list-item__cell--action"},St={class:"trade-list-item__fill-line"},Bt={key:1,class:"trade-list-item__fallback"},Ft=j({__name:"TradeListItem",props:{escrow:{},escrowLink:{}},setup(a){const n=a,_=Ee(n,"escrow"),{data:d}=He(_),h=I(!1),p=u(()=>d.value),M=u(()=>n.escrow?.account.depositToken.toBase58()??""),N=u(()=>{const b=p.value;if(!b||!Number.isFinite(b.requestAmount))return"–";const c=b.requestAmount;return Number.isInteger(c)?String(c):c.toFixed(6).replace(/\.?0+$/,"")}),g=u(()=>{const b=p.value;return b&&te(b.priceSymbol||b.requestName)||""}),S=u(()=>{const b=p.value;if(!b)return"";const c=b.pricePerUnit??0,w=te(b.depositSymbol||b.depositName)||"deposit",T=te(b.priceSymbol||b.requestName)||"request";if(!c||!Number.isFinite(c))return"–";if(h.value){const k=1/c,U=Number.isFinite(k)?Number.isInteger(k)?String(k):k.toFixed(6).replace(/\.?0+$/,""):"–";return`1 ${T} = ${U} ${w}`}return`1 ${w} = ${c} ${T}`});return(b,c)=>{const w=Xe;return l(),i("div",ht,[p.value?(l(),i(B,{key:0},[s("div",gt,[q(m(We),{amount:p.value.depositAmount,decimals:p.value.depositDecimals,symbol:p.value.depositSymbol,name:p.value.depositName,mint:M.value,"show-mint-short":!1},null,8,["amount","decimals","symbol","name","mint"])]),s("div",Tt,[s("span",Ct,[ve(y(N.value)+" ",1),s("span",Mt,y(g.value),1)])]),s("div",$t,[s("span",Nt,y(S.value),1),s("button",{type:"button",class:"trade-list-item__flip","aria-label":"Flip unit price",onClick:c[0]||(c[0]=T=>h.value=!h.value)},[q(m(A),{icon:"mdi:swap-horizontal"})])]),s("div",qt,[q(w,{to:a.escrowLink,class:"trade-list-item__fill"},{default:fe(()=>[c[1]||(c[1]=s("span",{class:"trade-list-item__fill-line"},"Fill",-1)),s("span",St,y(a.escrow.account.allowPartialFill?"Partial":"Full"),1)]),_:1},8,["to"])])],64)):(l(),i("span",Bt,"Loading..."))])}}}),_e=Y(Ft,[["__scopeId","data-v-701b798f"]]),Lt={class:"trade-list"},At={class:"trade-list__section"},Rt={class:"trade-list__table"},Dt={class:"trade-list__items"},Et={key:0,class:"trade-list__empty"},It={class:"trade-list__section"},xt={class:"trade-list__table"},Pt={class:"trade-list__items"},Ut={key:0,class:"trade-list__empty"},Ot=j({__name:"TradeList",props:{offerTrades:{},requestTrades:{},escrowLink:{type:Function}},setup(a){return(n,_)=>(l(),i("div",Lt,[s("section",At,[_[1]||(_[1]=s("h3",{class:"trade-list__heading"},"Offered",-1)),s("div",Rt,[_[0]||(_[0]=de('<div class="trade-list__header" data-v-15228e8e><span class="trade-list__cell trade-list__cell--deposit" data-v-15228e8e>Deposit</span><span class="trade-list__cell trade-list__cell--requested" data-v-15228e8e>Requested</span><span class="trade-list__cell trade-list__cell--unit" data-v-15228e8e>Unit price</span><span class="trade-list__cell trade-list__cell--action" data-v-15228e8e></span></div>',1)),s("div",Dt,[(l(!0),i(B,null,L(a.offerTrades,d=>(l(),R(_e,{key:d.publicKey.toBase58(),escrow:d,"escrow-link":a.escrowLink(d.publicKey.toBase58())},null,8,["escrow","escrow-link"]))),128)),a.offerTrades.length?$("",!0):(l(),i("p",Et,"No offers"))])])]),s("section",It,[_[3]||(_[3]=s("h3",{class:"trade-list__heading"},"Requested",-1)),s("div",xt,[_[2]||(_[2]=de('<div class="trade-list__header" data-v-15228e8e><span class="trade-list__cell trade-list__cell--deposit" data-v-15228e8e>Deposit</span><span class="trade-list__cell trade-list__cell--requested" data-v-15228e8e>Requested</span><span class="trade-list__cell trade-list__cell--unit" data-v-15228e8e>Unit price</span><span class="trade-list__cell trade-list__cell--action" data-v-15228e8e></span></div>',1)),s("div",Pt,[(l(!0),i(B,null,L(a.requestTrades,d=>(l(),R(_e,{key:d.publicKey.toBase58(),escrow:d,"escrow-link":a.escrowLink(d.publicKey.toBase58())},null,8,["escrow","escrow-link"]))),128)),a.requestTrades.length?$("",!0):(l(),i("p",Ut,"No requests"))])])])]))}}),Vt=Y(Ot,[["__scopeId","data-v-15228e8e"]]);function Kt(a,n,_){let d=0,h=0;if(a.assetType==="NFT_COLLECTION"&&a.collectionMint&&a.mint===a.collectionMint){const p=_.get(a.mint)??[];for(const M of p){const N=n.get(M);N&&(d+=N.offerTrades.length,h+=N.requestTrades.length)}}else{const p=n.get(a.mint);d=p?.offerTrades.length??0,h=p?.requestTrades.length??0}return{...a,offerCount:d,requestCount:h}}const zt={class:"market-browse"},Ht={key:0,class:"market-browse__breadcrumbs"},Wt=["onClick"],jt={key:4,class:"market-browse__detail"},Yt={class:"market-browse__detail-meta"},Gt={class:"market-browse__detail-media"},Jt=["src","alt"],Qt={key:1,class:"market-browse__detail-placeholder"},Xt={class:"market-browse__detail-info"},Zt={class:"market-browse__detail-info-text"},es={class:"market-browse__detail-name"},ts={class:"market-browse__detail-ticker-row"},ss={key:0,class:"market-browse__detail-symbol"},as=["href"],ns={class:"market-browse__detail-address"},ls={key:0,class:"market-browse__detail-traits"},os={class:"market-browse__detail-traits-list"},is={class:"market-browse__detail-actions"},rs={class:"market-browse__detail-trades"},cs={key:5},us={key:0,class:"market-browse__toolbar"},ds={class:"market-browse__filters"},ms={key:0,class:"market-browse__filter-badge"},_s={key:0,class:"market-browse__filter-panel"},fs={class:"market-browse__filter-header"},vs={class:"market-browse__trait-label"},ps={class:"market-browse__trait-values"},bs=["onClick"],ks={key:2},ys={class:"market-browse__grid"},ws="11111111111111111111111111111111",hs=j({__name:"MarketBrowseView",props:{childNodes:{},descendantAssetNodes:{},selectedNode:{},selectedDetailMint:{},breadcrumbPath:{},selectNode:{type:Function},setSelectedDetailMint:{type:Function}},emits:["open-create-trade"],setup(a){const n=a,_=Ie(),{slug:d,marketplaceSettings:h}=xe(_),p=Pe(),M=u(()=>p.connectorState.value?.account??null),N=Ze(),{rpcUrl:g,rpcError:S}=Ge(),{escrowLink:b}=je(d),c=u(()=>{const e=n.selectedNode;return!e||e.kind!=="asset"||!e.mint?null:e.mint===e.collectionMint?e.mint:null}),{entries:w,mintsSet:T,mintsByCollection:k,loading:U,error:z,retry:G}=Je(d),J=u(()=>w.value.map(e=>e.mint)),{assets:Q,mintsByCollection:pe,loading:be}=Qe({slug:d,collection:c,limit:500}),ke=u(()=>g),{byMint:ae,retry:ye}=it(T,ke,{apiUrl:N,slug:d});Ue(()=>{(N.value||g.value)&&ye()});const X=u(()=>n.breadcrumbPath),ne=u(()=>n.selectedNode?.kind==="asset"&&n.selectedNode?.mint&&n.selectedNode?.mint===n.selectedNode?.collectionMint),we=u(()=>new Set(n.descendantAssetNodes.filter(e=>e.kind==="asset"&&!!e.mint).map(e=>e.mint))),le=u(()=>{const e=we.value;if(ne.value)return Q.value.filter(v=>!(v.assetType==="NFT_COLLECTION"&&v.mint===v.collectionMint));if(e.size===0)return[];const o=Q.value.filter(v=>e.has(v.mint)),t=[...e].filter(v=>!o.some(F=>F.mint===v));if(t.length===0)return o;const r=h.value;if(!r)return o;const f=[...o];for(const v of t){const F=r.currencyMints?.find(ee=>ee.mint===v);if(F){f.push({assetType:"CURRENCY",mint:F.mint,collectionMint:null,metadata:{name:F.name??null,symbol:F.symbol??null,image:null,decimals:null}});continue}const x=r.splAssetMints?.find(ee=>ee.mint===v);x&&f.push({assetType:"SPL_ASSET",mint:x.mint,collectionMint:null,metadata:{name:x.name??null,symbol:x.symbol??null,image:null,decimals:null}})}return f}),O=I(""),D=I({}),V=I(!1),oe=u(()=>et(le.value)),he=u(()=>Object.keys(oe.value).length>0),H=u(()=>Object.keys(D.value).length),ge=u(()=>{const e=st(le.value,O.value);return at(e,D.value)}),Te=u(()=>{const e=k.value,o=pe.value;if(!o)return e;const t=new Map(e);for(const[r,f]of o)t.has(r)||t.set(r,f);return t}),ie=u(()=>{const e=Te.value;return[...ge.value.map(t=>Kt(t,ae.value,e))].sort((t,r)=>{const f=(t.offerCount??0)+(t.requestCount??0)>0?1:0,v=(r.offerCount??0)+(r.requestCount??0)>0?1:0;if(v!==f)return v-f;const F=(t.metadata?.name??t.mint).toLowerCase(),x=(r.metadata?.name??r.mint).toLowerCase();return F.localeCompare(x)})}),Ce=u(()=>ie.value);Oe(()=>n.selectedNode?.id,()=>{O.value="",D.value={},V.value=!1});function Me(e,o){const t={...D.value};t[e]===o?delete t[e]:t[e]=o,D.value=t}function $e(){D.value={}}const C=u(()=>n.selectedDetailMint),Z=u(()=>!!C.value),re=u(()=>{const e=E.value;return e?.metadata?.traits?tt(e.metadata.traits):[]}),E=u(()=>{if(!C.value)return null;const e=Q.value.find(v=>v.mint===C.value);if(e)return e;const o=h.value;if(!o)return null;const t=o.currencyMints?.find(v=>v.mint===C.value);if(t)return{assetType:"CURRENCY",mint:t.mint,collectionMint:null,metadata:{name:t.name??null,symbol:t.symbol??null,image:null,decimals:null}};const r=o.splAssetMints?.find(v=>v.mint===C.value);if(r)return{assetType:"SPL_ASSET",mint:r.mint,collectionMint:null,metadata:{name:r.name??null,symbol:r.symbol??null,image:null,decimals:null}};const f=o.collectionMints?.find(v=>v.mint===C.value);return f?{assetType:"NFT_COLLECTION",mint:f.mint,collectionMint:f.mint,metadata:{name:f.name??null,symbol:null,image:f.image??null,decimals:null}}:null});function Ne(e,o){if(e.account.onlyWhitelist)return!1;if(!e.account.onlyRecipient)return!0;const t=e.account.recipient.toBase58();return t===ws?!0:o!==null&&t===o}const qe=u(()=>{const e=C.value;return e?ae.value.get(e)??{offerTrades:[],requestTrades:[]}:{offerTrades:[],requestTrades:[]}}),ce=u(()=>{const e=qe.value,o=M.value,t=r=>r.filter(f=>Ne(f,o));return{offerTrades:t(e.offerTrades),requestTrades:t(e.requestTrades)}});function Se(e){return e.metadata?.symbol?e.metadata.symbol:e.collectionMint&&h.value?.collectionMints?h.value.collectionMints.find(t=>t.mint===e.collectionMint)?.name??null:null}function Be(e){e.assetType==="NFT_COLLECTION"&&e.mint===e.collectionMint?(n.selectNode(`asset:${e.mint}`),n.setSelectedDetailMint(null)):(n.setSelectedDetailMint(e.mint),n.childNodes.some(r=>r.kind==="asset"&&r.mint===e.mint)&&n.selectNode(`asset:${e.mint}`))}function Fe(){n.setSelectedDetailMint(null)}const Le=u(()=>C.value?`https://solscan.io/token/${C.value}`:"#");function Ae(){C.value&&navigator.clipboard.writeText(C.value)}function ue(e){if(n.setSelectedDetailMint(null),e===null){n.selectNode(null);return}}return(e,o)=>(l(),i("div",zt,[X.value.length?(l(),i("nav",Ht,[s("button",{type:"button",class:"market-browse__breadcrumb market-browse__breadcrumb--root",onClick:o[0]||(o[0]=t=>ue(null))}," Market "),(l(!0),i(B,null,L(X.value,(t,r)=>(l(),i("span",{key:r,class:"market-browse__breadcrumb-sep"}," / "))),128)),(l(!0),i(B,null,L(X.value,(t,r)=>(l(),i("button",{key:r,type:"button",class:"market-browse__breadcrumb",onClick:f=>ue(r)},y(t),9,Wt))),128))])):$("",!0),m(S)&&!m(N)?(l(),R(m(W),{key:1,variant:"error",message:m(S)},null,8,["message"])):!Z.value&&(m(U)||m(be))?(l(),R(m(W),{key:2,variant:"loading",message:"Loading assets..."})):!Z.value&&m(z)?(l(),R(m(W),{key:3,variant:"error",message:m(z),retry:!0,onRetry:m(G)},null,8,["message","onRetry"])):Z.value?(l(),i("div",jt,[s("div",Yt,[s("div",Gt,[E.value?.metadata?.image?(l(),i("img",{key:0,src:E.value.metadata.image,alt:E.value.metadata.name??C.value,class:"market-browse__detail-img"},null,8,Jt)):(l(),i("div",Qt,[q(m(A),{icon:"mdi:image-off"})]))]),s("div",Xt,[s("div",Zt,[s("h2",es,y(E.value?.metadata?.name??m(se)(C.value)),1),s("div",ts,[E.value?.metadata?.symbol?(l(),i("span",ss,y(E.value.metadata.symbol),1)):$("",!0),s("button",{type:"button",class:"market-browse__detail-icon-btn","aria-label":"Copy address",onClick:Ae},[q(m(A),{icon:"mdi:content-copy"})]),s("a",{href:Le.value,target:"_blank",rel:"noopener",class:"market-browse__detail-icon-btn market-browse__detail-solscan","aria-label":"Jump to Solscan"},[q(m(A),{icon:"mdi:open-in-new"})],8,as)]),s("code",ns,y(C.value),1),re.value.length?(l(),i("div",ls,[o[4]||(o[4]=s("p",{class:"market-browse__detail-traits-label"},"Traits",-1)),s("div",os,[(l(!0),i(B,null,L(re.value,(t,r)=>(l(),i("span",{key:r,class:"market-browse__detail-trait-tag"},y(t.trait_type)+": "+y(t.value),1))),128))])])):$("",!0)]),s("div",is,[s("button",{type:"button",class:"market-browse__detail-btn market-browse__detail-btn--back",onClick:Fe},[q(m(A),{icon:"mdi:arrow-left",class:"market-browse__detail-btn-icon"}),o[5]||(o[5]=s("span",{class:"market-browse__detail-btn-label"},"Back",-1))]),s("button",{type:"button",class:"market-browse__detail-btn market-browse__detail-btn--create",onClick:o[1]||(o[1]=t=>e.$emit("open-create-trade"))},[q(m(A),{icon:"mdi:plus",class:"market-browse__detail-btn-icon"}),o[6]||(o[6]=s("span",{class:"market-browse__detail-btn-label"},"Create",-1))])])])]),s("div",rs,[q(Vt,{"offer-trades":ce.value.offerTrades,"request-trades":ce.value.requestTrades,"escrow-link":m(b)},null,8,["offer-trades","request-trades","escrow-link"])])])):(l(),i("div",cs,[ne.value&&he.value?(l(),i("div",us,[Ve(s("input",{"onUpdate:modelValue":o[2]||(o[2]=t=>O.value=t),type:"text",class:"market-browse__search",placeholder:"Search by name, number, or mint..."},null,512),[[Ke,O.value]]),s("div",ds,[s("button",{type:"button",class:me(["market-browse__filter-btn",{"market-browse__filter-btn--active":V.value}]),onClick:o[3]||(o[3]=t=>V.value=!V.value)},[q(m(A),{icon:"mdi:filter-outline"}),o[7]||(o[7]=ve(" Filters ",-1)),H.value?(l(),i("span",ms,y(H.value),1)):$("",!0)],2),V.value?(l(),i("div",_s,[s("div",fs,[o[8]||(o[8]=s("span",null,"Filter by traits",-1)),H.value?(l(),i("button",{key:0,type:"button",onClick:$e},"Clear all")):$("",!0)]),(l(!0),i(B,null,L(oe.value,(t,r)=>(l(),i("div",{key:r,class:"market-browse__trait-group"},[s("p",vs,y(r),1),s("div",ps,[(l(!0),i(B,null,L(t,f=>(l(),i("button",{key:`${r}-${f}`,type:"button",class:me(["market-browse__trait-chip",{"market-browse__trait-chip--active":D.value[r]===f}]),onClick:v=>Me(r,f)},y(f),11,bs))),128))])]))),128))])):$("",!0)])])):$("",!0),Ce.value.length?(l(),i("div",ks,[s("div",ys,[(l(!0),i(B,null,L(ie.value,t=>(l(),R(wt,{key:t.mint,mint:t.mint,"asset-type":t.assetType,name:t.metadata?.name??null,symbol:Se(t),image:t.metadata?.image??null,"offer-count":t.offerCount,"request-count":t.requestCount,"collection-mint":t.collectionMint,onSelect:Be},null,8,["mint","asset-type","name","symbol","image","offer-count","request-count","collection-mint"]))),128))])])):(l(),R(m(W),{key:1,variant:"empty",message:J.value.length===0?"No assets in scope.":H.value||O.value?"No items match your filters.":"No items to display."},null,8,["message"]))]))]))}}),Rs=Y(hs,[["__scopeId","data-v-61e1e9ab"]]);export{Rs as default};
