import{I}from"./Cov751Ou.js";import{e as L,C as M,r as l,J as y,z as W,K as F,L as O,c,b as k,w as S,k as e,h as b,o as r,a as B,t as _,F as R,i as U,g as T,d as V,M as J,N as A,_ as P}from"./Cuem3LDA.js";import{B as q}from"./Bl7VwagC.js";import{C as z}from"./DzKUzsOz.js";import{C as K}from"./CSnhJXAl.js";import{u as Y}from"./CJvSuGTU.js";import"./DG6ESaol.js";import"./C-xuITp_.js";const G={class:"verify-page"},H={key:0,class:"verify-page__error"},Q={key:1,class:"verify-page__error"},X={key:2,class:"verify-page__success"},Z={key:0,class:"verify-page__error"},ee=L({__name:"verify",setup(te){const x=M(),g=Y(),o=b(()=>x.query.token??""),f=l(!1),s=l(!1),u=l(null),n=l(null),m=l(!1),i=l(y()),v=b(()=>i.value.account);let h=null;W(()=>{h=F(()=>{i.value=y()}),o.value&&D()}),O(()=>{h?.()});async function D(){if(o.value)try{const a=await fetch(`${g.value}/api/v1/discord/verify/session?token=${encodeURIComponent(o.value)}`,{credentials:"include"});if(!a.ok){u.value="This link is invalid or has expired.";return}(await a.json()).valid||(u.value="This link has expired. Use /verify in Discord to get a new one.")}catch{u.value="Could not verify link. Check your connection."}}async function w(a){if(o.value){n.value=null,s.value=!0;try{const t=g.value.replace(/\/$/,""),d=await fetch(`${t}/api/v1/auth/nonce`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({wallet:a}),credentials:"include"});if(!d.ok){const p=await d.json().catch(()=>({}));n.value=p.error??"Failed to get nonce";return}const{nonce:$}=await d.json(),{signature:j,message:E}=await J($),C=await fetch(`${t}/api/v1/discord/verify/link`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({verify_token:o.value,wallet:a,message:E,signature:j}),credentials:"include"});if(!C.ok){const p=await C.json().catch(()=>({}));n.value=p.error??"Link failed";return}m.value=!0,f.value=!1}catch(t){n.value=t instanceof Error?t.message:"Something went wrong"}finally{s.value=!1}}}async function N(a){if(o.value){n.value=null,s.value=!0;try{if(await A(a),i.value=y(),!i.value.account){n.value="Wallet not connected";return}await w(i.value.account)}catch(t){n.value=t instanceof Error?t.message:"Something went wrong"}finally{s.value=!1}}}return(a,t)=>(r(),c("div",G,[k(e(z),{class:"verify-page__card"},{default:S(()=>[t[3]||(t[3]=B("h1",{class:"verify-page__title"},"Link wallet to Discord",-1)),e(o)?e(u)?(r(),c("p",Q,_(e(u)),1)):e(m)?(r(),c("p",X,"Wallet linked. You can close this page and return to Discord.")):(r(),c(R,{key:3},[t[2]||(t[2]=B("p",{class:"verify-page__intro"}," Connect your wallet to link it to your Discord account for role verification. ",-1)),k(e(q),{variant:"primary",disabled:e(s),onClick:t[0]||(t[0]=d=>e(v)?w(e(v)):f.value=!0)},{default:S(()=>[e(s)?(r(),U(e(I),{key:0,icon:"mdi:loading",class:"verify-page__spinner"})):T("",!0),V(" "+_(e(v)?"Link this wallet":"Connect wallet"),1)]),_:1},8,["disabled"]),e(n)?(r(),c("p",Z,_(e(n)),1)):T("",!0),k(e(K),{open:e(f),title:"Connect wallet",description:"Choose a wallet to link to your Discord account.",connectors:e(i).connectors,loading:e(s),error:e(n),onClose:t[1]||(t[1]=d=>f.value=!1),onSelect:N},null,8,["open","connectors","loading","error"])],64)):(r(),c("p",H,"Invalid link. Use /verify in your Discord server to get a new link."))]),_:1})]))}}),ue=P(ee,[["__scopeId","data-v-78d5c888"]]);export{ue as default};
