import{d as te,S as x,P as f,T as he,e as S,C as Ae}from"./DG6ESaol.js";import{A as fe,P as de}from"./B39xTx9h.js";import{g as R,A as h,T as g,N as pe,c as Pe,b as Te,d as be,e as Se}from"./BqRXT9UV.js";import{u as Ee}from"./CJvSuGTU.js";import{Y as Me,h as oe}from"./Cuem3LDA.js";function Re(){const n=Me().public.heliusRpc?.trim()??"",t=n.length>0,a=oe(()=>t?n.replace(/\/$/,""):""),s=oe(()=>t?null:"Set NUXT_PUBLIC_HELIUS_RPC in your environment. The public Solana RPC returns 403 and cannot be used.");return{rpcUrl:a,hasRpc:t,rpcError:s}}var Ie={version:"0.1.0",name:"escrow_service",instructions:[{name:"initialize",accounts:[{name:"maker",isMut:!0,isSigner:!0},{name:"makerAta",isMut:!0,isSigner:!1},{name:"recipient",isMut:!1,isSigner:!1,isOptional:!0},{name:"depositToken",isMut:!1,isSigner:!1},{name:"requestToken",isMut:!1,isSigner:!1},{name:"auth",isMut:!1,isSigner:!1},{name:"vault",isMut:!0,isSigner:!1},{name:"escrow",isMut:!0,isSigner:!1},{name:"tokenProgram",isMut:!1,isSigner:!1},{name:"associatedTokenProgram",isMut:!1,isSigner:!1},{name:"systemProgram",isMut:!1,isSigner:!1},{name:"fee",isMut:!0,isSigner:!1},{name:"whitelistProgram",isMut:!1,isSigner:!1,isOptional:!0},{name:"whitelist",isMut:!1,isSigner:!1,isOptional:!0},{name:"entry",isMut:!1,isSigner:!1,isOptional:!0}],args:[{name:"seed",type:"u64"},{name:"depositAmount",type:"u64"},{name:"requestAmount",type:"u64"},{name:"expireTimestamp",type:"i64"},{name:"allowPartialFill",type:"bool"},{name:"onlyWhitelist",type:"bool"},{name:"slippage",type:"f32"}]},{name:"cancel",accounts:[{name:"maker",isMut:!0,isSigner:!0},{name:"makerAta",isMut:!0,isSigner:!1},{name:"depositToken",isMut:!1,isSigner:!1},{name:"makerAtaRequest",isMut:!1,isSigner:!1},{name:"makerTokenRequest",isMut:!1,isSigner:!1},{name:"auth",isMut:!1,isSigner:!1},{name:"vault",isMut:!0,isSigner:!1},{name:"escrow",isMut:!0,isSigner:!1},{name:"tokenProgram",isMut:!1,isSigner:!1},{name:"associatedTokenProgram",isMut:!1,isSigner:!1},{name:"systemProgram",isMut:!1,isSigner:!1}],args:[]},{name:"exchange",accounts:[{name:"maker",isMut:!0,isSigner:!1},{name:"makerReceiveAta",isMut:!0,isSigner:!1},{name:"depositToken",isMut:!1,isSigner:!1},{name:"taker",isMut:!0,isSigner:!0},{name:"takerAta",isMut:!0,isSigner:!1},{name:"takerReceiveAta",isMut:!0,isSigner:!1},{name:"requestToken",isMut:!1,isSigner:!1},{name:"auth",isMut:!1,isSigner:!1},{name:"vault",isMut:!0,isSigner:!1},{name:"escrow",isMut:!0,isSigner:!1},{name:"tokenProgram",isMut:!1,isSigner:!1},{name:"associatedTokenProgram",isMut:!1,isSigner:!1},{name:"systemProgram",isMut:!1,isSigner:!1},{name:"fee",isMut:!0,isSigner:!1},{name:"whitelistProgram",isMut:!1,isSigner:!1,isOptional:!0},{name:"whitelist",isMut:!1,isSigner:!1,isOptional:!0},{name:"entry",isMut:!1,isSigner:!1,isOptional:!0}],args:[{name:"amount",type:"u64"}]}],accounts:[{name:"Escrow",type:{kind:"struct",fields:[{name:"maker",type:"publicKey"},{name:"depositToken",type:"publicKey"},{name:"requestToken",type:"publicKey"},{name:"tokensDepositInit",type:"u64"},{name:"tokensDepositRemaining",type:"u64"},{name:"price",type:"f64"},{name:"decimals",type:"i16"},{name:"slippage",type:"f32"},{name:"seed",type:"u64"},{name:"authBump",type:"u8"},{name:"vaultBump",type:"u8"},{name:"escrowBump",type:"u8"},{name:"expireTimestamp",type:"i64"},{name:"recipient",type:"publicKey"},{name:"onlyRecipient",type:"bool"},{name:"onlyWhitelist",type:"bool"},{name:"allowPartialFill",type:"bool"},{name:"whitelist",type:"publicKey"}]}}],errors:[{code:6e3,name:"AuthBumpError",msg:"Unable to get auth bump"},{code:6001,name:"VaultBumpError",msg:"Unable to get vault bump"},{code:6002,name:"EscrowBumpError",msg:"Unable to get escrow bump"},{code:6003,name:"EscrowNotEnoughRemaining",msg:"Escrow has not enough funds reamining"},{code:6004,name:"EscrowRecipientError",msg:"Wrong recipient input"},{code:6005,name:"EscrowFeeError",msg:"Wrong fee account input"},{code:6006,name:"EscrowMinimumError",msg:"Wrong minimum"},{code:6007,name:"EscrowPartialFillNotAllowed",msg:"Partial fill is not allowed"},{code:6008,name:"EscrowTimestampExpired",msg:"Timestamp expired"},{code:6009,name:"WrongWhitelistProvided",msg:"Wrong whitelist is provided"},{code:6010,name:"DecimalPrecisionLoss",msg:"Decimal precision loss"},{code:6011,name:"SlippageLimitExceeded",msg:"Slippage limit exceeded"},{code:6012,name:"ConvertToFloat",msg:"Error converting to float"}]},N="esccxeEDYUXQaeMwq1ZwWAvJaHVYfsXNva13JYb2Chs",ne="whi5uDPWK4rAE9Sus6hdxdHwsG1hjDBn6kXM6pyqwTn",ge="feeLpAUDSsYBMwpxvVr5hwwDQE32BcWXRfAd3A6agWx",Be=Ie;function ye(){const e=JSON.parse(JSON.stringify(Be));return e.address=N,e.types&&Array.isArray(e.types)&&e.types.length===0&&delete e.types,e}function F(e,n){const t=new fe(e,n,{commitment:"confirmed",preflightCommitment:"confirmed"}),a=new f(N);return new de(ye(),a,t)}function we(e){const n={publicKey:f.default,signTransaction:async s=>s,signAllTransactions:async s=>s},t=new fe(e,n,{commitment:"confirmed",preflightCommitment:"confirmed"}),a=new f(N);return new de(ye(),a,t)}function i(e,n="Invalid PublicKey"){if(e instanceof f)return e;if(!e||typeof e!="string")throw new Error(n);try{return new f(e)}catch(t){throw new Error(`${n}: ${t.message}`,{cause:t})}}function M(e,n="Invalid BN value"){if(e instanceof S)return e;if(e==null)throw new Error(n);try{return e instanceof Uint8Array||Array.isArray(e)?new S(e):typeof e=="bigint"?new S(e.toString()):new S(String(e))}catch(t){throw new Error(`${n}: ${t.message}`,{cause:t})}}function ke(e,n,t=ne){const a=typeof t=="string"?new f(t):t,[s]=f.findProgramAddressSync([e.toBuffer(),n.toBuffer()],a);return s}function se(e,n,t){const a=M(n),[s]=f.findProgramAddressSync([Buffer.from("escrow"),e.toBuffer(),a.toArrayLike(Buffer,"le",8)],t),[o]=f.findProgramAddressSync([Buffer.from("auth"),s.toBuffer()],t),[r]=f.findProgramAddressSync([Buffer.from("vault"),s.toBuffer()],t);return{auth:o,vault:r,escrow:s}}async function K(e,n,t,a=g){try{const s=i(e),o=i(n),r=R(s,o,!1,a,h);return await Te(t,r,"confirmed",a),!0}catch{return!1}}function H(e,n,t,a=g){const s=i(e),o=i(n),r=t?i(t):o,d=R(s,o,!1,a,h);return be(r,d,o,s,a,h)}var ve=new f("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr");function ae(e){if(!e||typeof e!="string")throw new Error("Memo text must be a non-empty string");const n=Buffer.from(e,"utf8");return new he({keys:[],programId:ve,data:n})}var qe=new f("TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb"),_e=new f("CoREENxT6tW1HoK8ypY1SxRMZTcVPm7R94rH4PZNhX7d");async function ie(e,n,t="deposit"){const a=n instanceof f?n:new f(n),s=await e.getAccountInfo(a);if(!s)throw new Error(`Mint account not found: ${a.toBase58()}`);const o=s.owner;if(o.equals(g))return g;throw o.equals(qe)?new Error(`This ${t} token uses Token-2022. Our escrow supports only legacy SPL Token.`):o.equals(_e)?new Error(`This ${t} NFT uses MPL Core. Our escrow supports only legacy SPL Token.`):new Error(`This ${t} token is not legacy SPL (owner: ${o.toBase58()}).`)}var ce={ATA_CREATION:.0022},Ne=3e4;function Oe(e){const n=i(e.maker),t=i(e.taker),a=i(e.depositTokenMint),s=i(e.requestTokenMint);return{makerReceiveAta:R(s,n,!1,g,h),takerAta:R(s,t,!1,g,h),takerReceiveAta:R(a,t,!1,g,h)}}async function Ce(e){const{transaction:n,requestTokenMint:t,depositTokenMint:a,taker:s,connection:o}=e,r=i(t),d=i(a),c=i(s),u=await K(r,c,o),m=await K(d,c,o);let l=0;return u||(n.add(H(r,c,c)),l+=ce.ATA_CREATION),m||(n.add(H(d,c,c)),l+=ce.ATA_CREATION),{takerAtaExists:u,takerReceiveAtaExists:m,totalCost:l}}function xe(e){return(e instanceof f?e:new f(e)).equals(pe)}function We(e){const n=e instanceof f?e:new f(e);return R(pe,n,!1,g,h)}async function Le(e){if(e.requestAmount)return M(e.requestAmount);if(e.fetchEscrowAccount){const n=await e.fetchEscrowAccount(),t=new S(Math.floor(n.price*1e9));return e.amountBN.mul(t).div(new S(1e9))}throw new Error("Cannot calculate request amount: need requestAmount or fetchEscrowAccount")}var ue=new S(2039280);async function De(e){const{requestAmountLamports:n,accountExists:t,connection:a,wrappedSolAccount:s}=e;if(!t)return n.add(ue);try{const r=(await a.getParsedAccountInfo(s)).value?.data,d=(r&&typeof r=="object"&&"parsed"in r?r.parsed?.info?.tokenAmount?.uiAmount:void 0)??0,c=new S(Math.floor(d*1e9));return c.gte(n)?new S(0):n.sub(c)}catch{return n.add(ue)}}function $e(e){const{transaction:n,takerPubkey:t,wrappedSolAccount:a,solToTransfer:s,accountExists:o}=e;s.gt(new S(0))&&n.add(x.transfer({fromPubkey:t,toPubkey:a,lamports:s.toNumber()})),(!o||s.gt(new S(0)))&&n.add(Pe(a,g))}async function ze(e){const{maker:n,depositTokenMint:t,requestTokenMint:a,depositAmount:s,requestAmount:o,seed:r,expireTimestamp:d=0,allowPartialFill:c,onlyWhitelist:u,slippage:m,recipient:l,whitelistProgram:w,whitelist:y,entry:P,contractFeeAccount:A,memo:T,connection:p,wallet:E}=e,b=new te;T?.trim()&&b.add(ae(T.trim()));const O=i(N),k=i(n),C=M(r),{auth:j,vault:G,escrow:V}=se(k,C,O),I=i(t),v=i(a);await ie(p,I,"deposit"),await ie(p,v,"request");const X=R(I,k,!1,g,h),W=i(A??ge),q=F(p,E),B=!!y?.trim(),L=B?i(w??ne):q.programId,_=B?i(y):q.programId,D=B?ke(k,_,L):q.programId,Y=l?(()=>{const U=i(l);if(U.equals(x.programId))throw new Error("Cannot use SystemProgram as recipient.");return U})():q.programId;await K(I,k,p)||b.add(H(I,k,k)),await K(v,k,p)||b.add(H(v,k,k));const z=M(s),J=M(o),Q=M(d??0),$={maker:k,makerAta:X,recipient:Y,depositToken:I,requestToken:v,auth:j,vault:G,escrow:V,tokenProgram:g,associatedTokenProgram:h,systemProgram:x.programId,fee:W,whitelistProgram:L,whitelist:_,entry:P?i(P):D},Z=await q.methods.initialize(C,z,J,Q,c,u,m).accounts($).instruction();return b.add(Z),await re(p,b,k),b}async function re(e,n,t){const{blockhash:a,lastValidBlockHeight:s}=await e.getLatestBlockhash();n.recentBlockhash=a,n.feePayer=t,s!=null&&(n.lastValidBlockHeight=s)}async function Je(e){const{maker:n,depositTokenMint:t,requestTokenMint:a,seed:s,memo:o,connection:r,wallet:d}=e,c=new te;o?.trim()&&c.add(ae(o.trim()));const u=i(N),m=M(s),l=i(n),{auth:w,vault:y,escrow:P}=se(l,m,u),A=i(t),T=i(a),p=R(A,l,!1,g,h),E=R(T,l,!1,g,h),O=await F(r,d).methods.cancel().accounts({maker:l,makerAta:p,depositToken:A,makerAtaRequest:E,makerTokenRequest:T,auth:w,vault:y,escrow:P,tokenProgram:g,associatedTokenProgram:h,systemProgram:x.programId}).instruction();return c.add(O),await re(r,c,l),c}async function Qe(e){const{maker:n,taker:t,depositTokenMint:a,requestTokenMint:s,amount:o,seed:r,requestAmount:d,contractFeeAccount:c,whitelistProgram:u,whitelist:m,entry:l,memo:w,connection:y,wallet:P}=e,A=new te;w?.trim()&&A.add(ae(w.trim()));const T=i(N),p=i(t),E=M(r),b=i(n),{auth:O,vault:k,escrow:C}=se(b,E,T),{makerReceiveAta:j,takerAta:G,takerReceiveAta:V}=Oe({maker:b,taker:t,depositTokenMint:a,requestTokenMint:s}),I=i(a),v=i(s),X=i(c??ge),{takerAtaExists:W,totalCost:q}=await Ce({transaction:A,requestTokenMint:v,depositTokenMint:I,taker:p,connection:y});if(xe(s)){const $=We(p),Z=await Le({requestAmount:d??void 0,fetchEscrowAccount:async()=>F(y,P).account.escrow.fetch(C),amountBN:M(o)}),U=await De({wrappedSolAccount:$,requestAmountLamports:Z,accountExists:W,connection:y});$e({transaction:A,takerPubkey:p,wrappedSolAccount:$,solToTransfer:U,accountExists:W})}const B=F(y,P),L=M(o),_=!!m?.trim(),D=_?i(u??ne):B.programId,Y=_?i(m):B.programId,z=_?ke(p,i(m),D):B.programId,J={maker:b,makerReceiveAta:j,depositToken:I,taker:p,takerAta:G,takerReceiveAta:V,requestToken:v,auth:O,vault:k,escrow:C,tokenProgram:g,associatedTokenProgram:h,systemProgram:x.programId,fee:X,whitelistProgram:D,whitelist:Y,entry:l?i(l):z},Q=await B.methods.exchange(L).accounts(J).instruction();return A.add(Q),await re(y,A,p),A}async function Ze(e,n,t,a,s={}){const{simulate:o=!0}=s,{blockhash:r,lastValidBlockHeight:d}=await e.getLatestBlockhash();n.recentBlockhash=r,n.feePayer=a,d!=null&&(n.lastValidBlockHeight=d);const c=await t.signTransaction(n);if(o){const u=await e.simulateTransaction(c);if(u.value.err){const m=u.value.logs?.join(`
`)??"",l=m?`Simulation failed:
${m}`:`Simulation failed: ${JSON.stringify(u.value.err)}`;throw new Error(l)}}try{const u=await e.sendRawTransaction(c.serialize(),{skipPreflight:!1});return await e.confirmTransaction(u),u}catch(u){const m=u instanceof Error?u.message:String(u),l=u,w=l.logs??l.data?.logs,y=Array.isArray(w)&&w.length?`${m}
${w.join(`
`)}`:m;throw new Error(y)}}async function et(e,n){try{const t=we(e),a=i(n),s=await t.account.escrow.fetch(a);return{publicKey:a,account:s}}catch(t){if(t.message.includes("Account does not exist"))return null;throw t}}async function tt(e,n){const t=Ne,a=(async()=>await we(e).account.escrow.all())(),s=new Promise((o,r)=>{setTimeout(()=>r(new Error(`Request timed out after ${t/1e3} seconds.`)),t)});return Promise.race([a,s])}var me="metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s";function Ue(e){const[n]=f.findProgramAddressSync([Buffer.from("metadata"),new f(me).toBuffer(),new f(e).toBuffer()],new f(me));return n}function le(e){if(e==null)return null;const n=e.trim();return n.length>0?n:null}async function Fe(e,n){const t={mint:n,name:null,symbol:null,image:null,decimals:null,sellerFeeBasisPoints:null};try{const a=new f(n),s=await Se(e,a);t.decimals=s.decimals}catch{}try{const a=Ue(n),s=await e.getAccountInfo(a);if(!s?.data)return t;const o=s.data;let r=65;if(r+4>o.length)return t;const d=o.readUInt32LE(r);if(r+=4,r+d>o.length||(t.name=le(o.subarray(r,r+d).toString("utf8")),r+=d,r+4>o.length))return t;const c=o.readUInt32LE(r);if(r+=4,r+c>o.length||(t.symbol=le(o.subarray(r,r+c).toString("utf8")),r+=c,r+4>o.length))return t;const u=o.readUInt32LE(r);if(r+=4,r+u<=o.length&&u>0){const m=o.subarray(r,r+u).toString("utf8").trim();if(m&&!m.startsWith("http://localhost"))try{let l=m;m.startsWith("ipfs://")?l=`https://ipfs.io/ipfs/${m.replace("ipfs://","").replace(/^\/+/,"")}`:m.startsWith("ar://")&&(l=`https://arweave.net/${m.replace("ar://","").replace(/^\/+/,"")}`);const w=new AbortController,y=setTimeout(()=>w.abort(),2500),P=await fetch(l,{signal:w.signal,headers:{Accept:"application/json"}});if(clearTimeout(y),P.ok&&P.headers.get("content-type")?.includes("application/json")){const T=await P.json();let p=T.image??T.image_uri??null;p?.startsWith("ipfs://")?p=`https://ipfs.io/ipfs/${p.replace("ipfs://","").replace(/^\/+/,"")}`:p?.startsWith("ar://")&&(p=`https://arweave.net/${p.replace("ar://","").replace(/^\/+/,"")}`),t.image=p;const E=T.seller_fee_basis_points;t.sellerFeeBasisPoints=typeof E=="number"&&E>=0&&E<=1e4?E:null}}catch{}}}catch{}return t}const ee=new Map;function Ke(e){return{mint:e.mint,name:e.name??"",symbol:e.symbol??"",image:e.image??null,decimals:e.decimals??0}}function nt(){const e=Ee();async function n(t,a=!1){const s=t,o=ee.get(s);if(o&&!a)return o;if(!a&&e.value){const d=`${e.value}/api/v1/marketplace/metadata/mint/${encodeURIComponent(t)}`;try{const c=await fetch(d);if(c.ok){const u=await c.json();return ee.set(s,u),u}}catch{}}const{rpcUrl:r}=Re();if(!r.value)return null;try{const d=new Ae(r.value),c=await Fe(d,t),u=Ke(c);return ee.set(s,u),u}catch{return null}}return{fetchMetadata:n}}export{N as E,nt as a,Je as b,Qe as c,et as d,ze as e,tt as f,se as g,Ze as s,Re as u};
